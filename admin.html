<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot ç®¡ç†åå°</title>
    <link rel="stylesheet" href="bot_style.css">
    <style>
        .col-layout { grid-template-columns: 1.5fr 1.2fr 1.8fr 1.8fr 3.2fr 0.8fr; } /* è°ƒæ•´åˆ—å®½ç»™æ—¶é—´æ¡†è…¾ä½ç½® */
        
        /* æ—¶é—´è¾“å…¥æ¡†ç»„æ ·å¼ */
        .time-group {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .time-input-wrapper {
            position: relative;
            flex: 1;
        }
        .time-input {
            width: 100%;
            padding: 8px 4px 8px 8px; /* å³è¾¹ç•™å°‘ç‚¹ï¼Œæ”¾å•ä½ */
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(167, 209, 255, 0.2);
            border-radius: 6px;
            color: #fff;
            font-family: inherit;
            font-size: 0.95rem;
            outline: none;
            text-align: center;
        }
        .time-unit {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
            font-size: 0.75rem;
            pointer-events: none;
        }
        .time-input:focus {
            border-color: var(--text-highlight);
            background: rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body>
    <header>
        <div class="brand"><h1>ğŸ”§ ç®¡ç†åå°</h1></div>
        <nav class="nav-links"><a href="status.html" target="_blank">æŸ¥çœ‹å‰å° â†—</a></nav>
    </header>

    <main>
        <div class="hero-box" style="padding: 15px; margin-bottom: 20px;">
            <div id="network-status">æ­£åœ¨æ£€æµ‹ç½‘ç»œ...</div>
            <p style="margin-top: 5px; font-size: 0.9rem;">
                åˆæœ‰botè¢«å°ï¼Ÿä½•æ„å‘³
            </p>
        </div>

        <div class="login-card">
            <h3 style="color:var(--text-highlight); margin-bottom:15px;">ğŸ” ç®¡ç†å‘˜éªŒè¯</h3>
            <input type="password" id="key" class="admin-input" placeholder="è¾“å…¥å¯†é’¥ (é»˜è®¤123456)" style="text-align:center; font-size:1.1rem;">
        </div>

        <div class="admin-list-container">
            <div class="list-header col-layout">
                <div>ğŸ¤– åç§°</div>
                <div>ğŸ·ï¸ å¤‡æ³¨</div>
                <div>ğŸ”¢ QQ å·ç </div>
                <div>ğŸ“¡ è¿è¡ŒçŠ¶æ€</div>
                <div>â±ï¸ å°ç¦æ—¶é•¿</div>
                <div>æ“ä½œ</div>
            </div>

            <div id="list-box"></div>
            <button class="btn btn-add" onclick="add()">+ æ·»åŠ ä¸€ä¸ªæ–° Bot è´¦å·</button>
        </div>

        <button class="btn btn-save" onclick="save()">ğŸ’¾ ä¿å­˜æ‰€æœ‰æ›´æ”¹</button>
    </main>

    <script>
        let API_BASE = '';
        if (window.location.hostname.includes('akiyo.fun')) {
            API_BASE = '/api/bot';
            document.getElementById('network-status').innerText = 'å½“å‰ç¯å¢ƒ: çº¿ä¸ŠæœåŠ¡å™¨ (Nginx)';
        } else {
            API_BASE = 'http://127.0.0.1:5001';
            document.getElementById('network-status').innerText = 'å½“å‰ç¯å¢ƒ: æœ¬åœ°è°ƒè¯• (Port 5001)';
        }

        const GET_API = API_BASE + '/accounts';
        const POST_API = API_BASE + '/admin/update';

        let list = [];

        fetch(GET_API)
            .then(r => r.json())
            .then(data => { list = data; render(); })
            .catch(() => alert('è¿æ¥å¤±è´¥ï¼Œè¯·ç¡®è®¤åç«¯ bot_server.py æ˜¯å¦å¯åŠ¨ï¼'));

        function render() {
            const box = document.getElementById('list-box');
            box.innerHTML = '';
            
            list.forEach((item, i) => {
                const isTemp = item.status === 'temp';
                const showDuration = isTemp ? 'flex' : 'none';
                
                // è®¡ç®—å‰©ä½™æ—¶é—´ï¼Œæ‹†åˆ†ä¸º å¤©/æ—¶/åˆ†
                let d=0, h=0, m=0;
                if(isTemp && item.unban_date) {
                    const mins = getMinutesFromNow(item.unban_date);
                    if(mins > 0) {
                        d = Math.floor(mins / 1440);
                        h = Math.floor((mins % 1440) / 60);
                        m = mins % 60;
                    }
                }

                box.innerHTML += `
                <div class="admin-item col-layout">
                    <div>
                        <label class="mobile-label" style="display:none;font-size:0.8rem;color:#888;">åç§°</label>
                        <input class="admin-input" value="${item.name}" placeholder="Botåç§°" oninput="edit(${i}, 'name', this.value)">
                    </div>

                    <div>
                        <label class="mobile-label" style="display:none;font-size:0.8rem;color:#888;">å¤‡æ³¨</label>
                        <input class="admin-input" value="${item.note || ''}" placeholder="å¦‚: 1å·æœº" oninput="edit(${i}, 'note', this.value)" style="color:#ffd700;">
                    </div>
                    
                    <div>
                        <label class="mobile-label" style="display:none;font-size:0.8rem;color:#888;">QQ</label>
                        <input class="admin-input" type="number" value="${item.qq}" placeholder="QQå·" oninput="edit(${i}, 'qq', this.value)">
                    </div>

                    <div>
                        <label class="mobile-label" style="display:none;font-size:0.8rem;color:#888;">çŠ¶æ€</label>
                        <select class="admin-select" onchange="edit(${i}, 'status', this.value)" style="background:${getStatusColor(item.status)}">
                            <option value="ok" ${item.status=='ok'?'selected':''}>âœ… æ­£å¸¸è¿è¡Œ</option>
                            <option value="temp" ${item.status=='temp'?'selected':''}>â³ ä¸´æ—¶å†»ç»“</option>
                            <option value="ban" ${item.status=='ban'?'selected':''}>ğŸš« æ°¸ä¹…å°ç¦</option>
                        </select>
                    </div>

                    <div style="display:${showDuration}; align-items:flex-start; gap:8px; flex-direction:column;">
                        <div class="time-group" style="width:100%;">
                            <div class="time-input-wrapper">
                                <input id="d-${i}" class="time-input" type="number" min="0" value="${d}" oninput="updateDate(${i})">
                                <span class="time-unit">å¤©</span>
                            </div>
                            <div class="time-input-wrapper">
                                <input id="h-${i}" class="time-input" type="number" min="0" max="23" value="${h}" oninput="updateDate(${i})">
                                <span class="time-unit">æ—¶</span>
                            </div>
                            <div class="time-input-wrapper">
                                <input id="m-${i}" class="time-input" type="number" min="0" max="59" value="${m}" oninput="updateDate(${i})">
                                <span class="time-unit">åˆ†</span>
                            </div>
                        </div>

                        <div style="font-size:0.8rem; color:#888; white-space:nowrap;">
                            è§£å°: <span id="date-display-${i}" style="color:var(--text-highlight); font-weight:bold; font-family:monospace;">${item.unban_date || 'æœªè®¾ç½®'}</span>
                        </div>
                    </div>
                    
                    <div style="display:${!isTemp?'flex':'none'}; align-items:center; height:100%; color:#666; font-size:0.8rem;">
                        (æ— éœ€è®¾ç½®)
                    </div>

                    <div>
                        <button class="btn btn-del" onclick="del(${i})">ğŸ—‘ï¸</button>
                    </div>
                </div>`;
            });
            
            if(window.innerWidth <= 768) {
                document.querySelectorAll('.mobile-label').forEach(el => el.style.display = 'block');
                document.querySelectorAll('.admin-item').forEach(el => {
                    el.style.display = 'flex';
                    el.style.flexDirection = 'column';
                });
            }
        }

        // --- æ ¸å¿ƒé€»è¾‘ï¼šè¯»å–ä¸‰ä¸ªæ¡† -> ç®—å‡ºæ€»åˆ†é’Ÿ -> æ›´æ–°æ—¥æœŸ ---
        function updateDate(index) {
            // è·å–ä¸‰ä¸ªæ¡†çš„å€¼ï¼Œä¸ºç©ºåˆ™é»˜è®¤ä¸º0
            const d = parseInt(document.getElementById(`d-${index}`).value) || 0;
            const h = parseInt(document.getElementById(`h-${index}`).value) || 0;
            const m = parseInt(document.getElementById(`m-${index}`).value) || 0;

            if(d === 0 && h === 0 && m === 0) {
                list[index].unban_date = '';
                document.getElementById(`date-display-${index}`).innerText = 'æœªè®¾ç½®';
                return;
            }

            const totalMinutes = (d * 1440) + (h * 60) + m;
            
            const date = new Date();
            date.setMinutes(date.getMinutes() + totalMinutes); // å½“å‰æ—¶é—´ + æ€»åˆ†é’Ÿ
            
            const timeString = formatTime(date);
            list[index].unban_date = timeString;
            
            // æ›´æ–°æ–‡å­—æ˜¾ç¤º
            document.getElementById(`date-display-${index}`).innerText = timeString;
        }

        // --- è¾…åŠ©ï¼šæ ¼å¼åŒ–æ—¶é—´ YYYY-MM-DD HH:mm ---
        function formatTime(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hour = String(date.getHours()).padStart(2, '0');
            const minute = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day} ${hour}:${minute}`;
        }

        // --- è¾…åŠ©ï¼šç®—å‡ºå‰©ä½™åˆ†é’Ÿæ•° (ç”¨äºåˆå§‹åŒ–å›æ˜¾) ---
        function getMinutesFromNow(dateStr) {
            if (!dateStr || !dateStr.includes(':')) return 0; 
            const target = new Date(dateStr);
            const now = new Date();
            const diffMs = target - now;
            const diffMins = Math.ceil(diffMs / 60000); 
            return diffMins > 0 ? diffMins : 0;
        }

        function getStatusColor(status) {
            if(status === 'ok') return 'rgba(102, 187, 106, 0.2)';
            if(status === 'temp') return 'rgba(255, 167, 38, 0.2)';
            return 'rgba(239, 83, 80, 0.2)';
        }

        function edit(i, k, v) { list[i][k] = v; if(k==='status') render(); }
        function add() { list.push({name:'æ–°Bot', note:'1å·æœº', qq:'', status:'ok', unban_date:''}); render(); }
        function del(i) { if(confirm('åˆ é™¤æ­¤è´¦å·ï¼Ÿ')) { list.splice(i, 1); render(); } }

        function save() {
            const k = document.getElementById('key').value;
            if(!k) return alert('è¯·è¾“å…¥å¯†é’¥');
            const btn = document.querySelector('.btn-save');
            const oldText = btn.innerText;
            btn.innerText = 'ä¿å­˜ä¸­...';
            fetch(POST_API, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ key: k, accounts: list })
            }).then(r=>r.json()).then(d => {
                alert(d.message); btn.innerText = oldText;
            }).catch(()=> { alert("ä¿å­˜å¤±è´¥"); btn.innerText = oldText; });
        }
    </script>
</body>
</html>